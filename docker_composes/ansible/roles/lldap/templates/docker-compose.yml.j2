---
# GENERATED BY {{ container_name }} ROLE!!!
services:
  lldap:
    image: lldap/lldap:stable
    container_name: {{ container_name }}
    labels:
      - traefik.enable=true
      # https access
      - traefik.http.routers.{{ container_name }}.rule=Host(`${URL}`)
      - traefik.http.routers.{{ container_name }}.entrypoints=websecure
      - traefik.http.routers.{{ container_name }}.tls=true
      - traefik.http.routers.{{ container_name }}.tls.certresolver=letsencrypt
      - traefik.http.services.{{ container_name }}.loadbalancer.server.port=17170
    ports:
      # For LDAP, not recommended to expose, see Usage section.
      #- "3890:3890"
      # For LDAPS (LDAP Over SSL), enable port if LLDAP_LDAPS_OPTIONS__ENABLED set true, look env below
      # - "6360:6360"
      # For the web front-end
      - "17170:17170"
    volumes:
      - {{ ansible_env.HOME }}/docker/composes/{{ container_name }}-docker/data/:/data:ro
      - {{ ansible_env.HOME }}/docker/composes/{{ container_name }}-docker/certs/:/certs:ro
    environment:
      - UID={{ puid }}
      - GID={{ pgid }}
      - TZ={{ tz }}
      - LLDAP_JWT_SECRET='${LLDAP_JWT_SECRET}'
      - LLDAP_KEY_SEED='${LLDAP_KEY_SEED}'
      - LLDAP_LDAP_BASE_DN=dc={{ domain_no_tld }},dc={{ domain_tld_only }}
      - LLDAP_LDAP_USER_PASS=${LLDAP_ADMIN_PASSWORD}
      # If using LDAPS, set enabled true and configure cert and key path
      # NOTE: This needs to be commented out until traefik creates the SSL cert. Then use extract.sh to dump
      # the fullchain.pem and privkey.pem. Run the extract.sh as a root cron job every once in a while. Then uncomment
      # and bounce this compose
      # - LLDAP_LDAPS_OPTIONS__ENABLED=true
      # - LLDAP_LDAPS_OPTIONS__CERT_FILE=/certs/${URL}-fullchain.pem
      # - LLDAP_LDAPS_OPTIONS__KEY_FILE=/certs/${URL}-privkey.pem
      # You can also set a different database:
      # - LLDAP_DATABASE_URL=mysql://mysql-user:password@mysql-server/my-database
      # - LLDAP_DATABASE_URL=postgres://postgres-user:password@postgres-server/my-database
      # If using SMTP, set the following variables
      - LLDAP_SMTP_OPTIONS__ENABLE_PASSWORD_RESET=true
      - LLDAP_SMTP_OPTIONS__SERVER={{ lldap_smtp_server }}
      - LLDAP_SMTP_OPTIONS__PORT={{ lldap_smtp_port }} # Check your smtp providor's documentation for this setting
      - LLDAP_SMTP_OPTIONS__SMTP_ENCRYPTION={{ lldap_smtp_encryption }} # How the connection is encrypted, either "NONE" (no encryption, port 25), "TLS" (sometimes called SSL, port 465) or "STARTTLS" (sometimes called TLS, port 587).
      - LLDAP_SMTP_OPTIONS__USER={{ lldap_smtp_user }} # The SMTP user, usually your email address
      - LLDAP_SMTP_OPTIONS__PASSWORD=${LLDAP_SMTP_PASSWORD} # The SMTP password
      - LLDAP_SMTP_OPTIONS__FROM={{ lldap_smtp_fullname }} <{{ lldap_smtp_user }}> # The header field, optional: how the sender appears in the email. The first is a free-form name, followed by an email between <>.
      - LLDAP_SMTP_OPTIONS__TO=admin <{{ admin_email }}> # Same for reply-to, optional.
      - LLDAP_HTTP_URL=https://${URL}
    networks:
      - {{ network_name }}
    restart: unless-stopped

networks:
  {{ network_name }}:
    external: true
